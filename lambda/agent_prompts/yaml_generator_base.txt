Generate GitHub Actions workflow YAML based on this pipeline design: {pipeline_design}.

WORKFLOW TRIGGERS (CRITICAL):
- The workflow MUST trigger ONLY when a pull request is closed (merged) to the main branch
- Use ONLY the `pull_request` trigger with `types: [closed]` and `branches: [main]`
- Example CORRECT format:
  on:
    pull_request:
      branches:
        - main
      types:
        - closed
- This ensures the workflow runs only when PRs are merged (closed) to main, not on PR open/update

Requirements:
- Use aws-actions/configure-aws-credentials@v4 for AWS authentication via OIDC (OpenID Connect)
- Configure AWS credentials using role-to-assume: ${{{{ secrets.AWS_ROLE_TO_ASSUME }}}} and aws-region: ${{{{ vars.AWS_REGION }}}}
- DO NOT use AWS_ACCESS_KEY_ID or AWS_SECRET_ACCESS_KEY - use OIDC authentication only
- Include security scanning and validation stages
- Reference secrets via secrets.* and variables via vars.*

CRITICAL: NPM SETUP (IF NPM IS USED):
- IF npm commands MUST be included for some reason, you MUST NOT include the `cache` parameter at all
- NEVER use `cache: 'npm'` - it requires a lock file (package-lock.json) and will cause workflow failures with "Dependencies lock file is not found"
- DO NOT include any cache parameter when using actions/setup-node@v6
- ALL npm commands MUST include `|| true` to prevent workflow failures - this ensures the workflow continues even if npm commands fail
- Example CORRECT format (if npm setup is required):
  - uses: actions/setup-node@v6
    with:
      node-version: 24
      # DO NOT include cache parameter
  - name: Install dependencies
    run: npm ci || true
  - name: Run lint
    run: npm run lint || true
- Example INCORRECT format (DO NOT USE):
  - uses: actions/setup-node@v6
    with:
      node-version: 24
      cache: 'npm'  # ❌ WRONG - will fail if lock file doesn't exist
  - run: npm ci  # ❌ WRONG - will fail the workflow if npm ci fails
- Simply omit the cache parameter entirely - do not set it to any value
- ALWAYS append `|| true` to ALL npm commands (npm ci, npm install, npm run, npm test, etc.) to ensure workflow continues even on failure

CRITICAL: OIDC PERMISSIONS REQUIREMENT (MUST INCLUDE):
- When using aws-actions/configure-aws-credentials@v4 with OIDC, you MUST set permissions at the job level
- The `id-token: write` permission is REQUIRED for OIDC authentication - without it, the workflow will fail with "Could not load credentials"
- The `contents: read` permission is typically required for checkout and other operations
- Example CORRECT format (add permissions to EVERY job that uses AWS credentials):
  jobs:
    my-job:
      runs-on: ubuntu-latest
      permissions:
        id-token: write  # REQUIRED for OIDC
        contents: read    # Required for checkout and file operations
      steps:
        - uses: actions/checkout@v3
        - name: Configure AWS Credentials
          uses: aws-actions/configure-aws-credentials@v4
          with:
            role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
            aws-region: ${{ vars.AWS_REGION }}
- EVERY job that uses aws-actions/configure-aws-credentials@v4 MUST have these permissions
- If a job uses AWS credentials, it MUST have `id-token: write` permission or OIDC will fail

SECURITY SCANNING REQUIREMENTS (MANDATORY):
All security scans must use freely available, locally installable tools and MUST NOT fail the workflow:

1. SAST (Static Application Security Testing) - Use Semgrep:
   - name: Run Semgrep SAST
     continue-on-error: true
     run: |
       pip install semgrep
       semgrep --config auto . || true

2. SCA (Software Composition Analysis) - Use Trivy:
   - name: Trivy SCA (Filesystem)
     continue-on-error: true
     run: |
       trivy fs --scanners vuln . || true

3. Secrets Scanning - Use Trivy:
   - name: Trivy Secrets Scan
     continue-on-error: true
     run: |
       trivy fs --scanners secret . || true

4. IaC Security Scanning - Use Trivy AND Checkov:
   - name: Trivy IaC Scan
     continue-on-error: true
     run: |
       trivy config . || true
   
   - name: Run Checkov
     continue-on-error: true
     run: |
       pip install checkov
       checkov -d . || true

CRITICAL: Every security scan step MUST include `continue-on-error: true` OR append `|| true` to the command. Security scans are informational and should never block the pipeline.

CRITICAL JOB SEQUENCING RULES:
- If Terraform creates ECR resources, infrastructure job MUST run BEFORE container build job
- Use job dependencies (needs:) to enforce proper sequencing
- Infrastructure job should depend on quality/security checks
- Container build job should depend on infrastructure job when ECR is in Terraform

TERRAFORM SETUP REQUIREMENTS:
- ALWAYS setup Terraform CLI (hashicorp/setup-terraform@v3) BEFORE any terraform commands
- Use cli_config_credentials_token: ${{{{ secrets.TF_API_TOKEN }}}} if Terraform Cloud/Enterprise is used
- Setup step must come before terraform init, plan, or apply

CRITICAL: AWS CLI COMMAND FORMATTING:
- ALL AWS CLI commands MUST be written on a SINGLE LINE
- DO NOT split AWS CLI commands across multiple lines
- Use single-line format even if the command is long
- Example CORRECT format:
  run: aws ecs update-service --cluster ${{ env.ECS_CLUSTER }} --service ${{ env.ECS_SERVICE }} --force-new-deployment
- Example CORRECT format (with YAML literal block for multiple commands):
  run: |
    aws ecs update-service --cluster ${{ env.ECS_CLUSTER }} --service ${{ env.ECS_SERVICE }} --force-new-deployment
    aws ecs wait services-stable --cluster ${{ env.ECS_CLUSTER }} --services ${{ env.ECS_SERVICE }}
- Example INCORRECT format (DO NOT USE):
  run: |
    aws ecs update-service 
      --cluster ${{ env.ECS_CLUSTER }} 
      --service ${{ env.ECS_SERVICE }}
- This rule applies to ALL AWS CLI commands: aws ecs, aws ecr, aws sts, aws s3, etc.
- Other commands (terraform, docker, etc.) can use multi-line format if needed, but AWS CLI must always be single-line

ECR Configuration Handling:
{ecr_guidance}

ECS Configuration Handling:
{ecs_guidance}

Add concise comments and a README-style explanation after the YAML.

Return ONLY the workflow inside a ```yaml code fence followed immediately by the README text. Do not include any other prose before the YAML block.

